name: Create Production Builds

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build_android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x

      - name: ðŸ“¦ Install Expo and EAS globally
        run: |
          npm install -g expo-cli
          npm install -g eas-cli

      - name: ðŸ“¦ Install dependencies
        run: |
          cd frontend
          npm install
          # Verify installations
          npx expo --version
          npx eas --version

      - name: ðŸ”§ Create eas.json if not exists
        run: |
          cd frontend
          if [ ! -f eas.json ]; then
            echo '{
              "build": {
                "preview": {
                  "android": {
                    "buildType": "apk"
                  }
                }
              }
            }' > eas.json
          fi

      - name: ðŸš€ Build Android APK
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          cd frontend
          # Log in to Expo (using token)
          npx expo login --non-interactive --token $EXPO_TOKEN || true
          # Start the build
          npx eas build --platform android --profile preview --non-interactive

      - name: ðŸ“¤ Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: digital-bread-android-app
          path: frontend/build-*.apk
          if-no-files-found: warn
          retention-days: 30
